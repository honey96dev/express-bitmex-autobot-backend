!function(e){var t={};function s(r){if(t[r])return t[r].exports;var o=t[r]={i:r,l:!1,exports:{}};return e[r].call(o.exports,o,o.exports,s),o.l=!0,o.exports}s.m=e,s.c=t,s.d=function(e,t,r){s.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},s.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},s.t=function(e,t){if(1&t&&(e=s(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(s.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var o in e)s.d(r,o,function(t){return e[t]}.bind(null,o));return r},s.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return s.d(t,"a",t),t},s.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},s.p="/",s(s.s=19)}([function(e,t){e.exports=require("sprintf-js")},function(e,t){e.exports=require("lodash")},function(e,t){e.exports=require("express")},function(e,t){e.exports=require("crypto")},function(e,t){e.exports=require("cluster")},function(e,t){e.exports=require("debug")},function(e,t){e.exports=require("path")},function(e,t){e.exports=require("request")},function(e,t){e.exports=require("jsonwebtoken")},function(e,t){e.exports=require("ws-reconnect")},function(e,t){e.exports=require("http-errors")},function(e,t){e.exports=require("cookie-parser")},function(e,t){e.exports=require("morgan")},function(e,t){e.exports=require("express-jwt")},function(e,t){e.exports=require("cors")},function(e,t){e.exports=require("compression")},function(e,t){e.exports=require("mysql2")},function(e,t){e.exports=require("http")},function(e,t){e.exports=require("socket.io")},function(e,t,s){"use strict";s.r(t);var r=s(10),o=s.n(r),n=s(2),i=s.n(n),a=s(6),l=s.n(a),c=s(11),u=s.n(c),d=s(12),p=s.n(d),f=s(13),m=s.n(f),g=s(14),y=s.n(g),S=s(15),O=s.n(S);const b={isDev:!1,port:8e3,baseUrl:"http://127.0.0.1:8000/",name:"BitMEX Auto Bot",description:"BitMEX Auto Bot",author:"Zhenlong J.",secret:"blockreducer2@@",environment:"development",invitationCode:"23900",pingInterval:3e4,acceptSymbols:["XBTUSD","tETHUSD","tBABUSD","tEOSUSD","tLTCUSD","tBSVUSD"]},h={name:"BitMEX-Auto-Bot",key:"bitmex_autobot",secret:"bitmex_autobot@@"},E={users:"users",bots:"bots",apikeys:"apikeys",settings:"settings",tradeBucketed:"trade_bucketed",tradeBucketed1m:"trade_bucketed_1m",tradeBucketed5m:"trade_bucketed_5m",tradeBucketed1h:"trade_bucketed_1h"},w={testnet:!1,baseUrlRealnet:"https://www.bitmex.com/api/v1",baseUrlTestnet:"https://testnet.bitmex.com/api/v1",wsUrlTestnet:"wss://testnet.bitmex.com/realtime",wsUrlRealnet:"wss://www.bitmex.com/realtime",bufferSize:750,pathTradeBucketed:"/trade/bucketed",pathInstrument:"/instrument"},v={rowCount1:750,rowCount2:1e3,rowCount3:1250,rowCount4:1500,rowCount5:1750,rowCount6:2e3};var N={connectionLimit:10,host:"127.0.0.1",user:"root",password:"",database:"bitmex_autobot",port:3306};const k=i.a.Router();k.get("/",function(e,t,s){t.render("index",{title:"Express"})});var T=k,_=s(0),I=s.n(_),B=s(16),L=s.n(B).a.createPool(N),x="success",q="error",J="Unknown server error.",R="This email is already registered.",D="Successfully registered. Please try to sign in.",C="Your email is invalid",A="Your password is incorrect",U="Successfully signed in",K="Successfully changed",P="Successfully edited",M="Successfully added",j="Current password is incorrect",W="Invitation code is invalid",H="BinSize is invalid",V="Timezone is invalid",F="Symbol is invalid",X="Successfully connected",Y="No bot is ready",z="Successfully started",G="Successfully stopped",$="General reply",Q="Bot Order";const Z=i.a.Router();Z.get("/price-chart",(e,t,s)=>{const r=e.query,o=r.binSize,n=r.symbol;let i=r.startTime,a=r.endTime;const l=r.timezone;if(-1===b.acceptSymbols.indexOf(n))return void t.status(200).send({result:q,message:F});if(-1===["5m"].indexOf(o))return void t.status(200).send({result:q,message:H});if(void 0===l||null==l)return void t.status(200).send({result:q,message:V});const c=Object(_.sprintf)("%d:00:00",l);void 0!==a&&null!=a&&"null"!==a||(a=(new Date).toISOString()),void 0!==i&&null!=i&&"null"!==i||(i=new Date(new Date(a).getTime()-93312e6).toISOString()),i=new Date(i).toISOString(),a=new Date(a).toISOString();let u=Object(_.sprintf)("SELECT COUNT(`timestamp`) `count` FROM `%s_%s_%s` WHERE `timestamp` BETWEEN '%s' AND '%s';",E.tradeBucketed,n,o,i,a);L.query(u,null,(e,s,r)=>{if(e)return console.error(e),void t.status(200).send({result:q,message:J,data:[]});const l=s[0].count/v.rowCount2;u=Object(_.sprintf)("SELECT `timestamp`, AVG(`open`) `open`, AVG(`high`) `high`, AVG(`low`) `low`, AVG(`close`) `close` FROM (SELECT FLOOR((@row_number:=@row_number + 1)/%f) AS num, `timestamp`, `open`, `high`, `low`, `close` FROM (SELECT DATE_FORMAT(ADDTIME(STR_TO_DATE(`timestamp`, '%s'), '%s'), '%s') `timestamp`, `open`, `high`, `low`, `close` FROM `%s_%s_%s` WHERE `timestamp` BETWEEN '%s' AND '%s' ORDER BY `timestamp`) `bd`, (SELECT @row_number:=0) `row_num`  ORDER BY `timestamp` ASC) `tmp` GROUP BY `num`;",l,"%Y-%m-%dT%H:%i:%s.000Z",c,"%Y-%m-%dT%H:%i:%s.000Z",E.tradeBucketed,n,o,i,a),console.log(u),L.query(u,null,(e,s,r)=>{if(e)return console.error(e),void t.status(200).send({result:q,message:J,data:[]});t.status(200).send({result:x,data:s})})})});var ee=Z,te=s(8),se=s.n(te),re=s(3),oe=s.n(re),ne=e=>{return oe.a.createHmac("sha256",b.secret).update(e).digest("hex")};const ie=i.a.Router();ie.post("/sign-in",(e,t,s)=>{const r=e.body,o=r.email,n=r.password;let i=Object(_.sprintf)("SELECT `email` FROM `%s` WHERE BINARY `email` = '%s';",E.users,o);L.query(i,null,(e,s,r)=>{if(e)return console.error("auth/sign-in",JSON.stringify(e)),void t.status(200).send({result:q,message:J});if(0===s.length)return void t.status(200).send({result:q,message:C});const a=ne(n);i=Object(_.sprintf)("SELECT U.* FROM `%s` U WHERE BINARY U.email = '%s' AND BINARY U.hash = '%s';",E.users,o,a),console.log(i),L.query(i,null,(e,s,r)=>{if(e)return console.error("auth/sign-in",JSON.stringify(e)),void t.status(200).send({result:q,message:J});if(0===s.length)return void t.status(200).send({result:q,message:A});let o=s[0];o.token=se.a.sign({sub:o.id},h.secret),t.status(200).send({result:x,message:U,data:o})})})}),ie.post("/sign-up",(e,t,s)=>{const r=e.body,o=r.firstName,n=r.lastName,i=r.email,a=r.username,l=r.password,c=r.invitationCode;if(c!=b.invitationCode)return void t.status(200).send({result:q,message:W});let u=Object(_.sprintf)("SELECT `email` FROM `%s` WHERE BINARY `email` = '%s';",E.users,i);L.query(u,null,(e,s,r)=>{if(e)return console.error("auth/sign-in",JSON.stringify(e)),void t.status(200).send({result:q,message:J});if(s.length>0)return void t.status(200).send({result:q,message:R});const d=ne(l);u=Object(_.sprintf)("INSERT INTO `%s`(`username`, `email`, `firstName`, `lastName`, `hash`, `invitationCode`) VALUES('%s', '%s', '%s', '%s', '%s', '');",E.users,a,i,o,n,d,c),L.query(u,null,(e,s,r)=>{if(e)return console.error("auth/sign-in",JSON.stringify(e)),void t.status(200).send({result:q,message:J});t.status(200).send({result:x,message:D})})})});var ae=ie;const le=i.a.Router(),ce=(e,t,s)=>{const r=e.body,{userId:o}=r;let n=Object(_.sprintf)("SELECT * FROM `%s` WHERE `userId` = '%d';",E.apikeys,o);console.log(n),L.query(n,null,(e,s,r)=>{if(e)return console.error(__filename,JSON.stringify(e)),void t.status(200).send({result:q,message:J});t.status(200).send({result:x,message:M,data:s})})};le.post("/",(e,t,s)=>{ce(e,t)}),le.post("/add",(e,t,s)=>{const r=e.body,{userId:o,name:n,testnet:i,apiKey:a,apiKeySecret:l}=r,c=new Date,u=[null,o,n,i,a,l,Object(_.sprintf)("%04d-%02d-%02d",c.getFullYear(),c.getMonth()+1,c.getDate())];let d=Object(_.sprintf)("INSERT INTO `%s` VALUES ?",E.apikeys);L.query(d,[[u]],(e,s,r)=>{if(e)return console.error(__filename,JSON.stringify(e)),void t.status(200).send({result:q,message:J});t.status(200).send({result:x,message:M,data:{insertId:s.insertId}})})}),le.post("/edit",(e,t,s)=>{const r=e.body,{id:o,userId:n,name:i,testnet:a,apiKey:l,apiKeySecret:c}=r;let u=Object(_.sprintf)("UPDATE `%s` SET `userId` = '%d', `name` = '%s', `testnet` = '%d', `apiKey` = '%s', `apiKeySecret` = '%s' WHERE `id` = '%d';",E.apikeys,n,i,a,l,c,o);L.query(u,null,(e,s,r)=>{if(e)return console.error(__filename,JSON.stringify(e)),void t.status(200).send({result:q,message:J});t.status(200).send({result:x,message:P,data:{insertId:o}})})}),le.post("/delete",(e,t,s)=>{const r=e.body,{id:o}=r;let n=Object(_.sprintf)("DELETE FROM `%s` WHERE `id` = '%d';",E.apikeys,o);L.query(n,null,(s,r,o)=>{if(s)return console.error(__filename,JSON.stringify(s)),void t.status(200).send({result:q,message:J});ce(e,t)})});var ue=le;const de=i.a.Router(),pe=(e,t,s)=>{const r=e.body,{userId:o}=r;let n=Object(_.sprintf)("SELECT * FROM `%s` WHERE `userId` = '%d';",E.bots,o);L.query(n,null,(e,s,r)=>{if(e)return console.error(__filename,JSON.stringify(e)),void t.status(200).send({result:q,message:J});n=Object(_.sprintf)("SELECT * FROM `%s` WHERE `userId` = '%d';",E.settings,o),L.query(n,null,(e,r,o)=>{if(e)return console.error(__filename,JSON.stringify(e)),void t.status(200).send({result:q,message:J});let n=-1;r.length>0&&(n=r[0].activeBotId);for(let e of s)"bitmex"===e.exchange&&(e.exchange1="BitMEX"),e.id==n?e.active=1:e.active=0;t.status(200).send({result:x,data:s})})})};de.post("/",(e,t,s)=>{pe(e,t)}),de.post("/add",(e,t,s)=>{const r=e.body,{userId:o,name:n,exchange:i,symbol:a,orderType:l,postOnly:c,strategy:u,leverage:d,leverageValue:p,quantity:f,price:m,tpPercent:g,slPercent:y,trailingStop:S,numberOfSafeOrder:O,closeOrder1:b,newOrderOnSLPrice:h,valueOfLastCloseOrder:w,timesRepeatSameLogic1:v,closeOrder2:N,breakdownPriceForNewOrder:k,timeIntervalAfterClose:T,timesRepeatSameLogic2:I}=r,B=[null,o,n,i,a,l,c,u,d,p,f,m,g,y,S,O,b,h,w,v,N,k,T,I];let R=Object(_.sprintf)("INSERT INTO `%s` VALUES ?",E.bots);L.query(R,[[B]],(e,s,r)=>{if(e)return console.error(__filename,JSON.stringify(e)),void t.status(200).send({result:q,message:J});t.status(200).send({result:x,message:M,data:{insertId:s.insertId}})})}),de.post("/edit",(e,t,s)=>{const r=e.body,{id:o,name:n,exchange:i,symbol:a,orderType:l,postOnly:c,strategy:u,leverage:d,leverageValue:p,quantity:f,price:m,tpPercent:g,slPercent:y,trailingStop:S,numberOfSafeOrder:O,closeOrder1:b,newOrderOnSLPrice:h,valueOfLastCloseOrder:w,timesRepeatSameLogic1:v,closeOrder2:N,breakdownPriceForNewOrder:k,timeIntervalAfterClose:T,timesRepeatSameLogic2:I}=r;let B=Object(_.sprintf)("UPDATE `%s` SET `name` = '%s', `exchange` = '%s', `symbol` = '%s', `orderType` = '%s', `postOnly` = '%d', `strategy` = '%s', `leverage` = '%s', `leverageValue` = '%f', `quantity` = '%f', `price` = '%f', `tpPercent` = '%f', `slPercent` = '%f', `trailingStop` = '%f', `numberOfSafeOrder` = '%f', `closeOrder1` = '%d', `newOrderOnSLPrice` = '%d', `valueOfLastCloseOrder` = '%f', `timesRepeatSameLogic1` = '%d', `closeOrder2` = '%d', `breakdownPriceForNewOrder` = '%f', `timeIntervalAfterClose` = '%f', `timesRepeatSameLogic2` = '%d' WHERE `id` = '%d';",E.bots,n,i,a,l,c,u,d,p,f,m,g,y,S,O,b,h,w,v,N,k,T,I,o);L.query(B,null,(e,s,r)=>{if(e)return console.error(__filename,JSON.stringify(e)),void t.status(200).send({result:q,message:J});t.status(200).send({result:x,message:P,data:{insertId:o}})})}),de.post("/delete",(e,t,s)=>{const r=e.body,{id:o}=r;let n=Object(_.sprintf)("DELETE FROM `%s` WHERE `id` = '%d';",E.bots,o);L.query(n,null,(s,r,o)=>{if(s)return console.error(__filename,JSON.stringify(s)),void t.status(200).send({result:q,message:J});pe(e,t)})}),de.post("/activate",(e,t,s)=>{const r=e.body,{id:o,userId:n}=r;let i=Object(_.sprintf)("INSERT INTO `%s`(`userId`, `activeBotId`) VALUES('%d', '%d') ON DUPLICATE KEY UPDATE `activeBotId` = VALUES(`activeBotId`);",E.settings,n,o);L.query(i,null,(s,r,o)=>{if(s)return console.error(__filename,JSON.stringify(s)),void t.status(200).send({result:q,message:J});pe(e,t)})});var fe=de,me=s(7),ge=s.n(me),ye=s(1),Se=s.n(ye),Oe=s(5),be=s.n(Oe);const he=new be.a("bitmex:rest"),Ee="GET",we="POST",ve="DELETE";function Ne(e,t,s){this.testnet=e,this.apiKeyID=t,this.apiKeySecret=s;const r=this.testnet?"https://testnet.bitmex.com":"https://www.bitmex.com",o=r+"/api/v1";this.signMessage=(e,t,s,r,o)=>{!o||Se.a.isEmpty(o)?o="":Se.a.isObject(o)&&(o=JSON.stringify(o));const n=t+s+r+o;return oe.a.createHmac("sha256",e).update(n).digest("hex")},this.getTimestamp=(e,t)=>{ge()(o,(s,r,o)=>{if(!r||200!==r.statusCode)return void("function"==typeof t&&t(s));const n=JSON.parse(o);"function"==typeof e&&e(n.timestamp)})},this.request=(e,t,s,r,n,i)=>{he("request-begin"),e=e.toUpperCase();let a=this;if(r)this.getTimestamp(r=>{const l=parseInt(r/1e3+5),c=this.signMessage(this.apiKeySecret,e,"/api/v1"+t,l,s),u={"content-type":"application/json",Accept:"application/json","X-Requested-With":"XMLHttpRequest","api-expires":l,"api-key":this.apiKeyID,"api-signature":c};he("signature",e,t,l,c),!s||Se.a.isEmpty(s)?s="":Se.a.isObject(s)&&(s=JSON.stringify(s));const d={headers:u,url:o+t,method:e,body:s};he("request-options",JSON.stringify(d)),ge()(d,function(e,s,r){if(he("request",new Date,s.statusCode,d.method,d.url),e||200!==s.statusCode){console.warn("request",e,r,JSON.stringify(d)),"function"==typeof i&&i(r);const s=(new Date).toISOString();let o=I.a.sprintf("INSERT INTO `bitmex_log`(`timestamp`, `testnet`, `apiKeyID`, `apiKeySecret`, `message`) VALUES ('%s', '%d', '%s', '%s', '%s') ON DUPLICATE KEY UPDATE `testnet` = VALUES(`testnet`), `apiKeyID` = VALUES(`apiKeyID`), `apiKeySecret` = VALUES(`apiKeySecret`), `message` = VALUES(`message`);",s,a.testnet?1:0,a.apiKeyID,a.apiKeySecret,"Bitmex API fail: "+t);return console.log("sql-log",o),void L.query(o)}he("success",r);const o=JSON.parse(r);"function"==typeof n&&n(o)})},e=>{"function"==typeof i&&i(e)});else{const r={"content-type":"application/json",Accept:"application/json","X-Requested-With":"XMLHttpRequest"};!s||Se.a.isEmpty(s)?s="":Se.a.isObject(s)&&(s=JSON.stringify(s));const l={headers:r,url:o+t,method:e,body:s};ge()(l,function(e,s,r){if(he("request",new Date,s.statusCode,l.method,l.url),e||200!==s.statusCode){console.warn("request",e,r,JSON.stringify(l)),"function"==typeof i&&i(e);const s=(new Date).toISOString();let o=I.a.sprintf("INSERT INTO `bitmex_log`(`timestamp`, `testnet`, `apiKeyID`, `apiKeySecret`, `message`) VALUES ('%s', '%d', '%s', '%s', '%s') ON DUPLICATE KEY UPDATE `testnet` = VALUES(`testnet`), `apiKeyID` = VALUES(`apiKeyID`), `apiKeySecret` = VALUES(`apiKeySecret`), `message` = VALUES(`message`);",s,a.testnet?1:0,a.apiKeyID,a.apiKeySecret,"Bitmex API fail: "+t);return console.log("sql-log",o),void L.query(o)}he("success",r);const o=JSON.parse(r);"function"==typeof n&&n(o)})}},this.order=(e,t,s,r)=>{this.request(e,"/order",t,!0,s,r)},this.orderAll=(e,t,s)=>{this.request(ve,"/order/all",e,!0,t,s)},this.orderBulk=(e,t,s,r)=>{this.request(e,"/order/bulk",t,!0,s,r)},this.orderCancelAllAfter=(e,t,s)=>{this.request(we,"/order/cancelAllAfter",e,!0,t,s)},this.orderClosePosition=(e,t,s)=>{this.request(we,"/order/closePosition",e,!0,t,s)},this.orderBookL2=(e,t,s)=>{this.request(Ee,"/orderBook/L2",e,!1,t,s)},this.position=(e,t,s)=>{this.request(Ee,"/position",e,!0,t,s)},this.positionLeverage=(e,t,s)=>{this.request(we,"/position/leverage",e,!0,t,s)},this.trade=(e,t,s)=>{this.request(Ee,"/trade",e,!1,t,s)},this.tradeBucketed=(e,t,s)=>{this.request(Ee,"/trade/bucketed",e,!1,t,s)},this.user=(e,t,s)=>{this.request(Ee,"/user",e,!0,t,s)},this.userWallet=(e,t,s)=>{this.request(Ee,"/user/wallet",e,!0,t,s)},this.userWalletHistory=(e,t,s)=>{this.request(Ee,"/user/walletHistory",e,!0,t,s)}}const ke=i.a.Router();ke.post("/password",(e,t,s)=>{const{userId:r,oldPassword:o,password:n}=e.body,i=ne(o),a=ne(n);let l=`SELECT * FROM ${E.users} WHERE \`id\` = '${r}' AND \`hash\` = '${i}';`;L.query(l,null,(e,s,o)=>{if(e)return console.error(__filename,JSON.stringify(e)),void t.status(200).send({result:q,message:J});0!==s.length?(l=`UPDATE \`${E.users}\` SET \`hash\` = '${a}' WHERE \`id\` = '${r}';`,L.query(l,null,(e,s,r)=>{if(e)return console.error(__filename,JSON.stringify(e)),void t.status(200).send({result:q,message:J});t.status(200).send({result:x,message:K})})):t.status(200).send({result:q,message:j})})}),ke.post("/connect-to-exchange",(e,t,s)=>{const r=e.body,{testnet:o,apiKey:n,apiKeySecret:i}=r;new Ne(o,n,i).user({},e=>{t.status(200).send({result:x,message:X,data:e})},e=>{console.error("connectToExchange",JSON.stringify(e)),e=JSON.parse(e),t.status(200).send({result:q,message:e&&e.error?e.error.message:J})})});var Te=ke,_e=s(9),Ie=s.n(_e),Be="price",Le="orderBookL2_25",xe="wallet",qe="position",Je="connectToExchange",Re="connectedToExchange",De="disconnectFromExchange",Ce="disconnectedFromExchange",Ae="checkIsConnected",Ue="answerIsConnected",Ke="startBot",Pe="stopBot",Me="checkIsBotStarted",je="answerIsBotStarted";let We={timeoutDelay:3e4,webSocketTimeoutId:void 0,ioServer:void 0,prices:{},orderBooksL2_25:[],webSocket:void 0,webSocketLastTimestamp:void 0,subscribes:[],exchangeClients:new Map,apiKey2Socket:new Map,wallets:new Map,positions:new Map,bots:new Map,renewSocket:()=>{const e=(new Date).getTime();if(We.webSocketTimeoutId&&clearTimeout(We.webSocketTimeoutId),We.webSocketTimeoutId=setTimeout(We.renewSocket,We.timeoutDelay),We.webSocketLastTimestamp>e-We.timeoutDelay)return;const t=Boolean(w.testnet)?w.wsUrlTestnet:w.wsUrlRealnet;We.webSocket=new Ie.a(t,{retryCount:2,reconnectInterval:1}),console.error(__filename,"renewSocket",We.webSocketLastTimestamp),We.webSocket.on("connect",()=>{for(let e of We.subscribes)We.webSocket.send(e)}),We.webSocket.on("message",e=>{if(We.webSocketLastTimestamp=(new Date).getTime(),(e=JSON.parse(e)).request&&console.log(__filename,"message",JSON.stringify(e)),e.table){const t=e.table;"instrument"===t?We.onWsInstrument(e.action,e.data):"orderBookL2_25"===t&&We.onWsOrderBookL2_25(e.action,e.data)}}),We.webSocket.on("reconnect",e=>{const t=(new Date).toISOString();console.error(__filename,"reconnect",t)}),We.webSocket.on("destroyed",t=>{console.error(__filename,"destroyed",e)}),We.webSocket.start()},signMessage:(e,t,s,r,o)=>(!o||Se.a.isEmpty(o)?o="":Se.a.isObject(o)&&(o=JSON.stringify(o)),oe.a.createHmac("sha256",e).update(t+s+r+o).digest("hex")),initSocketIOServer:e=>{We.ioServer=e,e.on("connection",e=>{e.on(Je,t=>{const s=JSON.parse(t),{testnet:r,apiKey:o,apiKeySecret:n}=s;let i;if(We.exchangeClients.has(o)){if((i=We.exchangeClients.get(o)).isConnected)return}else{const e=Boolean(r)?w.wsUrlTestnet:w.wsUrlRealnet;i=new Ie.a(e,{retryCount:2,reconnectInterval:1})}i.on("connect",()=>{new Ne(r,o,n).getTimestamp(t=>{const r=parseInt(t/1e3+5),a=We.signMessage(n,"GET","/realtime",r);i.send(JSON.stringify({op:"authKeyExpires",args:[o,r,a]})),i.send(JSON.stringify({op:"subscribe",args:["orderBookL2_25:XBTUSD","order:XBTUSD","wallet","position:XBTUSD"]})),e.emit(Re,JSON.stringify(s))})}),i.on("message",e=>{const t=JSON.parse(e);if(t.request&&console.log(__filename,"message",e),t.table){const e=t.table;"order"===e?We.onWsOrder(o,t.action,t.data):"wallet"===e?We.onWsWallet(o,t.action,t.data):"position"===e&&We.onWsPosition(o,t.action,t.data)}}),i.on("reconnect",e=>{const t=(new Date).toISOString();console.error(__filename,"reconnect-client",o,t)}),i.on("destroyed",t=>{console.error(__filename,"destroyed-client",o),e.emit(Ce)}),i.start(),We.exchangeClients.set(o,i),We.apiKey2Socket.set(o,e)}),e.on(De,e=>{const t=JSON.parse(e),{testnet:s,apiKey:r,apiKeySecret:o}=t;We.exchangeClients.get(r).send(JSON.stringify({op:"unsubscribe",args:["orderBookL2_25:XBTUSD","order:XBTUSD","wallet","position:XBTUSD"]})),We.exchangeClients.get(r).destroy(),We.exchangeClients.delete(r)}),e.on(Ae,t=>{const s=JSON.parse(t),{testnet:r,apiKey:o,apiKeySecret:n}=s;let i;if(We.exchangeClients.has(o)){const t=We.exchangeClients.get(o);i=JSON.stringify({connected:t.isConnected,apiKey:s}),t.isConnected&&We.apiKey2Socket.set(o,e)}else i=JSON.stringify({connected:!1,apiKey:s});e.emit(Ue,i);let a=We.wallets.get(o);a&&e.emit(xe,JSON.stringify(a)),(a=We.positions.get(o))&&e.emit(qe,JSON.stringify(a))}),e.on(Ke,t=>{const s=JSON.parse(t),{testnet:r,apiKey:o,apiKeySecret:n,userId:i}=s;let a=Object(_.sprintf)("SELECT B.* FROM `%s` B JOIN `%s` S ON S.activeBotId = B.id WHERE S.userId = '%d';",E.bots,E.settings,i);L.query(a,null,(t,s,a)=>{if(t)return console.error(__filename,JSON.stringify(t)),void e.emit(je,JSON.stringify({started:!1,message:J}));if(0===s.length)return void e.emit(je,JSON.stringify({started:!1,message:Y}));const l=new Ne(r,o,n),c=s[0];let u;u={symbol:c.symbol,leverage:c.leverageValue},l.positionLeverage(u,e=>{const t="Long"===c.strategy,s="Limit"===c.orderType;u={symbol:c.symbol,side:t?"Buy":"Sell",orderQty:c.quantity,price:s?c.price:void 0,ordType:s?"Limit":"Market",text:Q},l.order(we,u,e=>{console.log("Bot-order",JSON.stringify(u))},e=>{console.error("Bot-order",JSON.stringify(e),JSON.stringify(u))});let r=Math.round(c.price*(1+(t?1:-1)*c.tpPercent/100));u={symbol:c.symbol,side:t?"Sell":"Buy",orderQty:Math.floor(c.quantity*c.tpPercent/100),ordType:"MarketIfTouched",execInst:"Close,LastPrice",stopPx:r,text:Q},l.order(we,u,e=>{console.log("take-profit",JSON.stringify(u))},e=>{console.error("take-profit",JSON.stringify(e),JSON.stringify(u))}),r=Math.round(c.price*(1-(t?1:-1)*c.slPercent/100)),u={symbol:c.symbol,side:t?"Sell":"Buy",orderQty:Math.floor(c.quantity*c.tpPercent/100),ordType:"Stop",execInst:"Close,LastPrice",stopPx:r,text:Q},l.order(we,u,e=>{console.log("stop-profit",JSON.stringify(u))},e=>{console.error("stop-profit",JSON.stringify(e),JSON.stringify(u))})},e=>{console.error("Bot-order-leverage",JSON.stringify(e),JSON.stringify(u))}),We.bots.set(i,{rest:l,config:c}),e.emit(je,JSON.stringify({started:!0,message:z}))})}),e.on(Pe,t=>{const s=JSON.parse(t),{testnet:r,apiKey:o,apiKeySecret:n,userId:i}=s;e.emit(je,JSON.stringify({started:!1,message:G}));const a=We.bots.get(i);console.error("bot",a);let l={symbol:a.config.symbol};a.rest.orderAll(l,e=>{We.bots.delete(i)},e=>{We.bots.delete(i)})}),e.on(Me,t=>{const s=JSON.parse(t),{testnet:r,apiKey:o,apiKeySecret:n,userId:i}=s;e.emit(je,JSON.stringify({started:We.bots.has(i),message:$}))})})},onWsInstrument:(e,t)=>{let s;for(let e of t)s=1,e.symbol&&e.lastPrice&&(We.prices[e.symbol]&&(s=Math.sign(e.lastPrice-We.prices[e.symbol].price)),We.prices[e.symbol]={price:e.lastPrice,direction:s}),We.ioServer.sockets.emit(Be,JSON.stringify(We.prices))},onWsOrderBookL2_25:(e,t)=>{if("partial"===e){We.orderBooksL2_25={Buy:[],Sell:[]};for(let e of t)We.orderBooksL2_25[e.side].push(e)}else if("update"===e){let e,s,r;for(let o of t)e=!1,s=Se.a.findIndex(We.orderBooksL2_25.Buy,{id:o.id}),r=Se.a.findIndex(We.orderBooksL2_25.Sell,{id:o.id}),-1!=s?(We.orderBooksL2_25.Buy[s].price=o.price?o.price:We.orderBooksL2_25.Buy[s].price,We.orderBooksL2_25.Buy[s].size=o.size?o.size:We.orderBooksL2_25.Buy[s].size):-1!=r&&(We.orderBooksL2_25.Sell[r].price=o.price?o.price:We.orderBooksL2_25.Sell[r].price,We.orderBooksL2_25.Sell[r].size=o.size?o.size:We.orderBooksL2_25.Sell[r].size)}else if("insert"===e)for(let e of t)We.orderBooksL2_25[e.side].push(e);else if("delete"===e)for(let e of t)Se.a.remove(We.orderBooksL2_25.Buy,{id:e.id}),Se.a.remove(We.orderBooksL2_25.Sell,{id:e.id});let s={Buy:We.orderBooksL2_25.Buy,Sell:We.orderBooksL2_25.Sell};We.ioServer.sockets.emit(Le,JSON.stringify(s))},onWsOrder:(e,t,s)=>{console.error(t,JSON.stringify(s))},onWsWallet:(e,t,s)=>{if("partial"===t)We.wallets.set(e,s);else if("insert"===t){let t=We.wallets.get(e);t=Se.a.concat(t,s),We.wallets.set(e,t)}else if("update"===t){let t,r=We.wallets.get(e);for(let e of s)t=Se.a.findIndex(r,{account:e.account}),Object.keys(e).map((s,o)=>{r[t][s]=e[s]});We.wallets.set(e,r)}else if("delete"===t){let t=We.wallets.get(e);for(let e of s)t=Se.a.remove(wallet,{account:e.account});We.wallets.set(e,t)}const r=We.apiKey2Socket.get(e);if(r){const t=We.wallets.get(e);r.emit(xe,JSON.stringify(t))}},onWsPosition:(e,t,s)=>{if("partial"===t)We.positions.set(e,s);else if("insert"===t){let t=We.positions.get(e);t=Se.a.concat(t,s),We.positions.set(e,t)}else if("update"===t){let t,r=We.positions.get(e);for(let e of s)t=Se.a.findIndex(r,{account:e.account,symbol:e.symbol}),Object.keys(e).map((s,o)=>{r[t][s]=e[s]});We.positions.set(e,r)}else if("delete"===t){let t=We.positions.get(e);for(let e of s)t=Se.a.remove(t,{account:e.account,symbol:e.symbol});We.positions.set(e,t)}const r=We.apiKey2Socket.get(e);if(r){const t=We.positions.get(e);r.emit(qe,JSON.stringify(t))}},start:e=>{if(We.subscribes=[],e instanceof Array){let t;for(let s of e)t=JSON.stringify({op:"subscribe",args:s}),We.subscribes.push(t)}We.renewSocket()}};var He=We;const Ve=i.a.Router();Ve.use("/",T),Ve.use("/auth",ae),Ve.use("/dashboard",ee),Ve.use("/register-bots",fe),Ve.use("/register-apikeys",ue),Ve.use("/settings",Te);var Fe=Ve;const Xe=i()();Xe.set("views",l.a.join(__dirname,"views")),Xe.set("view engine","pug"),Xe.use(p()("dev")),Xe.use(i.a.json()),Xe.use(i.a.urlencoded({extended:!1})),Xe.use(u()()),Xe.use(y()()),Xe.use(O()()),Xe.use("/api",m()({secret:h.secret}).unless({path:["/api/auth/sign-in","/api/auth/sign-up",/\/api\/market-sentiment\/one\/*/,/\/api\/market-sentiment\/collection\/*/,/\/api\/deribit\/data\/*/]})),Xe.use("/api",Fe),Xe.use(i.a.static(l.a.join(__dirname,"frontend"))),Xe.get("*",function(e,t){t.sendFile(l.a.join(__dirname,"frontend/index.html"))}),Xe.use(function(e,t,s){s(o()(404))}),Xe.use(function(e,t,s,r){s.locals.message=e.message,s.locals.error="development"===t.app.get("env")?e:{},s.status(e.status||500),s.render("error")});var Ye=Xe,ze=s(17),Ge=s.n(ze),$e=s(4),Qe=s.n($e),Ze=s(18),et=s.n(Ze);let tt,st,rt,ot;Qe.a.isMaster&&(Qe.a.fork(),Qe.a.on("exit",function(e,t,s){Qe.a.fork()})),Qe.a.isWorker&&(tt=new be.a("express:server"),st=function(e){const t=parseInt(e,10);if(isNaN(t))return e;if(t>=0)return t;return!1}(b.port),Ye.set("port",st),rt=Ge.a.createServer(Ye),ot=et()(rt),He.initSocketIOServer(ot),He.start(["instrument:XBTUSD","orderBookL2_25:XBTUSD"]),rt.listen(st),rt.on("error",function(e){if("listen"!==e.syscall)throw e;const t="string"==typeof st?"Pipe "+st:"Port "+st;switch(e.code){case"EACCES":console.error(t+" requires elevated privileges"),process.exit(1);break;case"EADDRINUSE":console.error(t+" is already in use"),process.exit(1);break;default:throw e}}),rt.on("listening",function(){const e=rt.address(),t="string"==typeof e?"pipe "+e:"port "+e.port;tt("Listening on "+t),console.log("Listening on "+t)}))}]);