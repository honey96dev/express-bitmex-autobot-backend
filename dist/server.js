!function(e){var t={};function s(r){if(t[r])return t[r].exports;var o=t[r]={i:r,l:!1,exports:{}};return e[r].call(o.exports,o,o.exports,s),o.l=!0,o.exports}s.m=e,s.c=t,s.d=function(e,t,r){s.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:r})},s.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},s.t=function(e,t){if(1&t&&(e=s(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var r=Object.create(null);if(s.r(r),Object.defineProperty(r,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var o in e)s.d(r,o,function(t){return e[t]}.bind(null,o));return r},s.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return s.d(t,"a",t),t},s.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},s.p="/",s(s.s=22)}([function(e,t){e.exports=require("sprintf-js")},function(e,t){e.exports=require("express")},function(e,t){e.exports=require("lodash")},function(e,t){e.exports=require("crypto")},function(e,t){e.exports=require("cluster")},function(e,t){e.exports=require("debug")},function(e,t){e.exports=require("path")},function(e,t){e.exports=require("request")},function(e,t){e.exports=require("jsonwebtoken")},function(e,t){e.exports=require("nodemailer")},function(e,t){e.exports=require("crypto-js")},function(e,t){e.exports=require("ws-reconnect")},function(e,t){e.exports=require("http-errors")},function(e,t){e.exports=require("cookie-parser")},function(e,t){e.exports=require("morgan")},function(e,t){e.exports=require("express-jwt")},function(e,t){e.exports=require("cors")},function(e,t){e.exports=require("compression")},function(e,t){e.exports=require("mysql2")},function(e,t){e.exports=require("email-templates")},function(e,t){e.exports=require("http")},function(e,t){e.exports=require("socket.io")},function(e,t,s){"use strict";s.r(t);var r=s(12),o=s.n(r),n=s(1),i=s.n(n),a=s(6),l=s.n(a),u=s(13),c=s.n(u),d=s(14),p=s.n(d),m=s(15),g=s.n(m),f=s(16),y=s.n(f),S=s(17),b=s.n(S);const O={isDev:!1,port:8e3,baseUrl:"http://127.0.0.1:8000/",name:"BitMEX Auto Bot",description:"BitMEX Auto Bot",author:"Zhenlong J.",secret:"blockreducer2@@",environment:"development",invitationCode:"23900",pingInterval:3e4,acceptSymbols:["XBTUSD","tETHUSD","tBABUSD","tEOSUSD","tLTCUSD","tBSVUSD"]},E={name:"BitMEX-Auto-Bot",key:"bitmex_autobot",secret:"bitmex_autobot@@"},h={users:"users",bots:"bots",apikeys:"apikeys",settings:"settings",tradeBucketed:"trade_bucketed",tradeBucketed1m:"trade_bucketed_1m",tradeBucketed5m:"trade_bucketed_5m",tradeBucketed1h:"trade_bucketed_1h"},v={testnet:!1,baseUrlRealnet:"https://www.bitmex.com/api/v1",baseUrlTestnet:"https://testnet.bitmex.com/api/v1",wsUrlTestnet:"wss://testnet.bitmex.com/realtime",wsUrlRealnet:"wss://www.bitmex.com/realtime",bufferSize:750,pathTradeBucketed:"/trade/bucketed",pathInstrument:"/instrument"},T={rowCount1:750,rowCount2:1e3,rowCount3:1250,rowCount4:1500,rowCount5:1750,rowCount6:2e3},N={service:"gmail",host:"smtp.gmail.com",port:465,secure:!0,user:"honey96dev@gmail.com",pass:"skdmlEmail@123456"};var w={connectionLimit:10,host:"127.0.0.1",user:"root",password:"",database:"bitmex_autobot",port:3306};const I=i.a.Router();I.get("/",function(e,t,s){t.render("index",{title:"Express"})});var k=I,B=s(0),L=s.n(B),U=s(18),_=s.n(U).a.createPool(w),A="Profit_Bot",q="success",x="error",J="Unknown server error.",D="This email is already registered.",R="Successfully registered. Please try to sign in.",C="Your email is invalid",K="Your password is incorrect",j="Your account is not allowed. Make sure your account allowed via email validation.",M="Sorry! Your account can not be activated. Your token is invalid.",P="Sorry! Your account can not be activated. Your token is expired.",W="Your account is successfully activated. Now you can use our website.",V="Successfully signed in",H="Successfully saved",Y="Successfully changed",F="Successfully edited",X="Successfully added",z="Current password is incorrect",Q="Invalid parameters",G="BinSize is invalid",$="Timezone is invalid",Z="Symbol is invalid",ee="Successfully connected",te="No bot is ready",se="Successfully started",re="Successfully stopped",oe="General reply",ne="Bot Order",ie="ApiKey is invalid",ae="Bot is invalid",le="Already Long position",ue="Already Short position";const ce=i.a.Router();ce.get("/price-chart",(e,t,s)=>{const r=e.query,o=r.binSize,n=r.symbol;let i=r.startTime,a=r.endTime;const l=r.timezone;if(-1===O.acceptSymbols.indexOf(n))return void t.status(200).send({result:x,message:Z});if(-1===["5m"].indexOf(o))return void t.status(200).send({result:x,message:G});if(void 0===l||null==l)return void t.status(200).send({result:x,message:$});const u=Object(B.sprintf)("%d:00:00",l);void 0!==a&&null!=a&&"null"!==a||(a=(new Date).toISOString()),void 0!==i&&null!=i&&"null"!==i||(i=new Date(new Date(a).getTime()-93312e6).toISOString()),i=new Date(i).toISOString(),a=new Date(a).toISOString();let c=Object(B.sprintf)("SELECT COUNT(`timestamp`) `count` FROM `%s_%s_%s` WHERE `timestamp` BETWEEN '%s' AND '%s';",h.tradeBucketed,n,o,i,a);_.query(c,null,(e,s,r)=>{if(e)return console.error(e),void t.status(200).send({result:x,message:J,data:[]});const l=s[0].count/T.rowCount2;c=Object(B.sprintf)("SELECT `timestamp`, AVG(`open`) `open`, AVG(`high`) `high`, AVG(`low`) `low`, AVG(`close`) `close` FROM (SELECT FLOOR((@row_number:=@row_number + 1)/%f) AS num, `timestamp`, `open`, `high`, `low`, `close` FROM (SELECT DATE_FORMAT(ADDTIME(STR_TO_DATE(`timestamp`, '%s'), '%s'), '%s') `timestamp`, `open`, `high`, `low`, `close` FROM `%s_%s_%s` WHERE `timestamp` BETWEEN '%s' AND '%s' ORDER BY `timestamp`) `bd`, (SELECT @row_number:=0) `row_num`  ORDER BY `timestamp` ASC) `tmp` GROUP BY `num`;",l,"%Y-%m-%dT%H:%i:%s.000Z",u,"%Y-%m-%dT%H:%i:%s.000Z",h.tradeBucketed,n,o,i,a),console.log(c),_.query(c,null,(e,s,r)=>{if(e)return console.error(e),void t.status(200).send({result:x,message:J,data:[]});t.status(200).send({result:q,data:s})})})});var de=ce,pe=s(8),me=s.n(pe),ge=s(3),fe=s.n(ge),ye=e=>{return fe.a.createHmac("sha256",O.secret).update(e).digest("hex")},Se=s(9),be=s.n(Se),Oe=s(19);const Ee=new(s.n(Oe).a)({message:{from:{address:N.user,name:O.name}},transport:{jsonTransport:!0}});var he=(e,t,s)=>{Ee.render("../email_templates/email_verify/html.pug",{name:t,tokenUrl:s}).then(t=>{console.log(s),console.log(t);let r=be.a.createTransport({host:N.host,port:N.port,secure:N.secure,auth:{user:N.user,pass:N.pass}});const o={from:"BitMEX AutoBOT",to:e,subject:"Welcome to BitMEX AutoBOT",html:t};r.sendMail(o,function(e,t){e?console.log(e):console.log("Email sent: "+JSON.stringify(t))})}).catch(console.error)};const ve=i.a.Router();ve.post("/sign-in",(e,t,s)=>{const r=e.body,o=r.email,n=r.password;let i=Object(B.sprintf)("SELECT `email` FROM `%s` WHERE BINARY `email` = '%s';",h.users,o);_.query(i,null,(e,s,r)=>{if(e)return console.error("auth/sign-in",JSON.stringify(e)),void t.status(200).send({result:x,message:J});if(0===s.length)return void t.status(200).send({result:x,message:C});const a=ye(n);i=Object(B.sprintf)("SELECT U.* FROM `%s` U WHERE BINARY U.email = '%s' AND BINARY U.hash = '%s';",h.users,o,a),console.log(i),_.query(i,null,(e,s,r)=>{if(e)return console.error("auth/sign-in",JSON.stringify(e)),void t.status(200).send({result:x,message:J});if(0===s.length)return void t.status(200).send({result:x,message:K});let o=s[0];0!=o.allow?(o.token=me.a.sign({sub:o.id},E.secret),t.status(200).send({result:q,message:V,data:o})):t.status(200).send({result:x,message:j})})})}),ve.post("/sign-up",(e,t,s)=>{const r=e.body,{firstName:o,lastName:n,email:i,username:a,password:l,invitationCode:u}=r;let c=Object(B.sprintf)("SELECT `email` FROM `%s` WHERE BINARY `email` = '%s';",h.users,i);_.query(c,null,(e,s,r)=>{if(e)return console.error("auth/sign-in",JSON.stringify(e)),void t.status(200).send({result:x,message:J});if(s.length>0)return void t.status(200).send({result:x,message:D});const d=ye(l);c=Object(B.sprintf)("INSERT INTO `%s` VALUES(NULL, '%s', '%s', '%s', '%s', '%s', '%s', '%s', '%s');",h.users,"user",a,i,o,n,d,u,0),_.query(c,null,(e,s,r)=>{if(e)return console.error("auth/sign-in",JSON.stringify(e)),void t.status(200).send({result:x,message:J});((e,t)=>{const s=ye((new Date).toISOString());let r=(new Date).getTime()+3e5;const o=Object(B.sprintf)("INSERT INTO `tokens`(`token`, `expire`, `email`) VALUES('%s', '%d', '%s');",s,r,e);_.query(o,null,(r,o,n)=>{if(!r){const r=Object(B.sprintf)("%sapi/verify/email?token=%s&email=%s",O.baseUrl,s,e);he(e,t,r)}})})(i),t.status(200).send({result:q,message:R})})})});var Te=ve;const Ne=i.a.Router(),we=(e,t,s)=>{const r=e.body,{userId:o}=r;let n=Object(B.sprintf)("SELECT * FROM `%s` WHERE `userId` = '%d';",h.apikeys,o);console.log(n),_.query(n,null,(e,s,r)=>{if(e)return console.error(__filename,JSON.stringify(e)),void t.status(200).send({result:x,message:J});t.status(200).send({result:q,message:X,data:s})})};Ne.post("/",(e,t,s)=>{we(e,t)}),Ne.post("/add",(e,t,s)=>{const r=e.body,{userId:o,name:n,testnet:i,apiKey:a,apiKeySecret:l}=r,u=new Date,c=[null,o,n,i,a,l,Object(B.sprintf)("%04d-%02d-%02d",u.getFullYear(),u.getMonth()+1,u.getDate())];let d=Object(B.sprintf)("INSERT INTO `%s` VALUES ?",h.apikeys);_.query(d,[[c]],(e,s,r)=>{if(e)return console.error(__filename,JSON.stringify(e)),void t.status(200).send({result:x,message:J});t.status(200).send({result:q,message:X,data:{insertId:s.insertId}})})}),Ne.post("/edit",(e,t,s)=>{const r=e.body,{id:o,userId:n,name:i,testnet:a,apiKey:l,apiKeySecret:u}=r;let c=Object(B.sprintf)("UPDATE `%s` SET `userId` = '%d', `name` = '%s', `testnet` = '%d', `apiKey` = '%s', `apiKeySecret` = '%s' WHERE `id` = '%d';",h.apikeys,n,i,a,l,u,o);_.query(c,null,(e,s,r)=>{if(e)return console.error(__filename,JSON.stringify(e)),void t.status(200).send({result:x,message:J});t.status(200).send({result:q,message:F,data:{insertId:o}})})}),Ne.post("/delete",(e,t,s)=>{const r=e.body,{id:o}=r;let n=Object(B.sprintf)("DELETE FROM `%s` WHERE `id` = '%d';",h.apikeys,o);_.query(n,null,(s,r,o)=>{if(s)return console.error(__filename,JSON.stringify(s)),void t.status(200).send({result:x,message:J});we(e,t)})});var Ie=Ne;const ke=i.a.Router(),Be=(e,t,s)=>{const r=e.body,{userId:o}=r;let n=Object(B.sprintf)("SELECT * FROM `%s` WHERE `userId` = '%d';",h.bots,o);_.query(n,null,(e,s,r)=>{if(e)return console.error(__filename,JSON.stringify(e)),void t.status(200).send({result:x,message:J});n=Object(B.sprintf)("SELECT * FROM `%s` WHERE `userId` = '%d';",h.settings,o),_.query(n,null,(e,r,o)=>{if(e)return console.error(__filename,JSON.stringify(e)),void t.status(200).send({result:x,message:J});let n=-1;r.length>0&&(n=r[0].activeBotId);const i={signal:"Signal",custom:"Custom"};for(let e of s)e.botLogic1=i[e.botLogic],e.id==n?e.active=1:e.active=0;t.status(200).send({result:q,data:s})})})};ke.post("/",(e,t,s)=>{Be(e,t)}),ke.post("/edit",(e,t,s)=>{const r=e.body,{id:o,userId:n,name:i,botLogic:a,leverage:l,closeOnTrigger:u,orderType:c,side:d,quantity:p,limitPrice:m}=r,g=[o,n,i,a,l,u,c,d,p,m];let f=Object(B.sprintf)("INSERT INTO `%s` VALUES ? ON DUPLICATE KEY UPDATE `userId` = VALUES(`userId`), `name` = VALUES(`name`), `botLogic` = VALUES(`botLogic`), `leverage` = VALUES(`leverage`), `closeOnTrigger` = VALUES(`closeOnTrigger`), `orderType` = VALUES(`orderType`), `side` = VALUES(`side`), `quantity` = VALUES(`quantity`), `limitPrice` = VALUES(`limitPrice`);",h.bots);_.query(f,[[g]],(e,s,r)=>{if(e)return console.error(__filename,JSON.stringify(e)),void t.status(200).send({result:x,message:J});t.status(200).send({result:q,message:o?F:X,data:{insertId:o||s.insertId}})})}),ke.post("/delete",(e,t,s)=>{const r=e.body,{id:o}=r;let n=Object(B.sprintf)("DELETE FROM `%s` WHERE `id` = '%d';",h.bots,o);_.query(n,null,(s,r,o)=>{if(s)return console.error(__filename,JSON.stringify(s)),void t.status(200).send({result:x,message:J});Be(e,t)})}),ke.post("/activate",(e,t,s)=>{const r=e.body,{id:o,userId:n}=r;let i=Object(B.sprintf)("INSERT INTO `%s`(`userId`, `activeBotId`) VALUES('%d', '%d') ON DUPLICATE KEY UPDATE `activeBotId` = VALUES(`activeBotId`);",h.settings,n,o);_.query(i,null,(s,r,o)=>{if(s)return console.error(__filename,JSON.stringify(s)),void t.status(200).send({result:x,message:J});Be(e,t)})});var Le=ke,Ue=s(7),_e=s.n(Ue),Ae=s(2),qe=s.n(Ae),xe=s(5),Je=s.n(xe);const De=new Je.a("bitmex:rest"),Re="GET",Ce="POST",Ke="DELETE";function je(e,t,s){this.testnet=e,this.apiKeyID=t,this.apiKeySecret=s;const r=this.testnet?"https://testnet.bitmex.com":"https://www.bitmex.com",o=r+"/api/v1";this.signMessage=(e,t,s,r,o)=>{!o||qe.a.isEmpty(o)?o="":qe.a.isObject(o)&&(o=JSON.stringify(o));const n=t+s+r+o;return fe.a.createHmac("sha256",e).update(n).digest("hex")},this.getTimestamp=(e,t)=>{_e()(o,(s,r,o)=>{if(!r||200!==r.statusCode)return void("function"==typeof t&&t(s));const n=JSON.parse(o);"function"==typeof e&&e(n.timestamp)})},this.request=(e,t,s,r,n,i)=>{De("request-begin"),e=e.toUpperCase();let a=this;if(r)this.getTimestamp(r=>{const l=parseInt(r/1e3+5),u=this.signMessage(this.apiKeySecret,e,"/api/v1"+t,l,s),c={"content-type":"application/json",Accept:"application/json","X-Requested-With":"XMLHttpRequest","api-expires":l,"api-key":this.apiKeyID,"api-signature":u};De("signature",e,t,l,u),!s||qe.a.isEmpty(s)?s="":qe.a.isObject(s)&&(s=JSON.stringify(s));const d={headers:c,url:o+t,method:e,body:s};De("request-options",JSON.stringify(d)),_e()(d,function(e,s,r){if(De("request",new Date,s.statusCode,d.method,d.url),e||200!==s.statusCode){console.warn("request",e,r,JSON.stringify(d)),"function"==typeof i&&i(r);const s=(new Date).toISOString();let o=L.a.sprintf("INSERT INTO `bitmex_log`(`timestamp`, `testnet`, `apiKeyID`, `apiKeySecret`, `message`) VALUES ('%s', '%d', '%s', '%s', '%s') ON DUPLICATE KEY UPDATE `testnet` = VALUES(`testnet`), `apiKeyID` = VALUES(`apiKeyID`), `apiKeySecret` = VALUES(`apiKeySecret`), `message` = VALUES(`message`);",s,a.testnet?1:0,a.apiKeyID,a.apiKeySecret,"Bitmex API fail: "+t);return console.log("sql-log",o),void _.query(o)}De("success",r);const o=JSON.parse(r);"function"==typeof n&&n(o)})},e=>{"function"==typeof i&&i(e)});else{const r={"content-type":"application/json",Accept:"application/json","X-Requested-With":"XMLHttpRequest"};!s||qe.a.isEmpty(s)?s="":qe.a.isObject(s)&&(s=JSON.stringify(s));const l={headers:r,url:o+t,method:e,body:s};_e()(l,function(e,s,r){if(De("request",new Date,s.statusCode,l.method,l.url),e||200!==s.statusCode){console.warn("request",e,r,JSON.stringify(l)),"function"==typeof i&&i(e);const s=(new Date).toISOString();let o=L.a.sprintf("INSERT INTO `bitmex_log`(`timestamp`, `testnet`, `apiKeyID`, `apiKeySecret`, `message`) VALUES ('%s', '%d', '%s', '%s', '%s') ON DUPLICATE KEY UPDATE `testnet` = VALUES(`testnet`), `apiKeyID` = VALUES(`apiKeyID`), `apiKeySecret` = VALUES(`apiKeySecret`), `message` = VALUES(`message`);",s,a.testnet?1:0,a.apiKeyID,a.apiKeySecret,"Bitmex API fail: "+t);return console.log("sql-log",o),void _.query(o)}De("success",r);const o=JSON.parse(r);"function"==typeof n&&n(o)})}},this.order=(e,t,s,r)=>{this.request(e,"/order",t,!0,s,r)},this.orderAll=(e,t,s)=>{this.request(Ke,"/order/all",e,!0,t,s)},this.orderBulk=(e,t,s,r)=>{this.request(e,"/order/bulk",t,!0,s,r)},this.orderCancelAllAfter=(e,t,s)=>{this.request(Ce,"/order/cancelAllAfter",e,!0,t,s)},this.orderClosePosition=(e,t,s)=>{this.request(Ce,"/order/closePosition",e,!0,t,s)},this.orderBookL2=(e,t,s)=>{this.request(Re,"/orderBook/L2",e,!1,t,s)},this.position=(e,t,s)=>{this.request(Re,"/position",e,!0,t,s)},this.positionLeverage=(e,t,s)=>{this.request(Ce,"/position/leverage",e,!0,t,s)},this.trade=(e,t,s)=>{this.request(Re,"/trade",e,!1,t,s)},this.tradeBucketed=(e,t,s)=>{this.request(Re,"/trade/bucketed",e,!1,t,s)},this.user=(e,t,s)=>{this.request(Re,"/user",e,!0,t,s)},this.userWallet=(e,t,s)=>{this.request(Re,"/user/wallet",e,!0,t,s)},this.userWalletHistory=(e,t,s)=>{this.request(Re,"/user/walletHistory",e,!0,t,s)}}const Me=i.a.Router();Me.post("/load-apikey",(e,t,s)=>{const r=e.body,{userId:o}=r;let n=Object(B.sprintf)("SELECT * FROM `%s` WHERE `userId` = '%d';",h.apikeys,o);_.query(n,null,(e,s,r)=>{if(e)return console.error(__filename,JSON.stringify(e)),void t.status(200).send({result:x,message:J});t.send({result:q,message:H,data:s.length>0?s[0]:{}})})}),Me.post("/save-apikey",(e,t,s)=>{const r=e.body,{userId:o,testnet:n,apiKey:i,apiKeySecret:a}=r,l=[o,n,i,a];let u=Object(B.sprintf)("INSERT `%s` VALUES ? ON DUPLICATE KEY UPDATE `testnet` = VALUES(`testnet`), `apiKey` = VALUES(`apiKey`), `apiKeySecret` = VALUES(`apiKeySecret`);",h.apikeys);_.query(u,[[l]],(e,s,r)=>{if(e)return console.error(__filename,JSON.stringify(e)),void t.status(200).send({result:x,message:J});t.send({result:q,message:H})})}),Me.post("/password",(e,t,s)=>{const{userId:r,oldPassword:o,password:n}=e.body,i=ye(o),a=ye(n);let l=`SELECT * FROM ${h.users} WHERE \`id\` = '${r}' AND \`hash\` = '${i}';`;_.query(l,null,(e,s,o)=>{if(e)return console.error(__filename,JSON.stringify(e)),void t.status(200).send({result:x,message:J});0!==s.length?(l=`UPDATE \`${h.users}\` SET \`hash\` = '${a}' WHERE \`id\` = '${r}';`,_.query(l,null,(e,s,r)=>{if(e)return console.error(__filename,JSON.stringify(e)),void t.status(200).send({result:x,message:J});t.status(200).send({result:q,message:Y})})):t.status(200).send({result:x,message:z})})}),Me.post("/connect-to-exchange",(e,t,s)=>{const r=e.body,{testnet:o,apiKey:n,apiKeySecret:i}=r;new je(o,n,i).user({},e=>{t.status(200).send({result:q,message:ee,data:e})},e=>{console.error("connectToExchange",JSON.stringify(e)),e=JSON.parse(e),t.status(200).send({result:x,message:e&&e.error?e.error.message:J})})}),Me.post("/load-personal-chart",(e,t,s)=>{const r=e.body,{userId:o}=r;let n=Object(B.sprintf)("SELECT * FROM `%s` WHERE `userId` = '%d';",h.settings,o);_.query(n,null,(e,s,r)=>{if(e)return console.error(__filename,JSON.stringify(e)),void t.status(200).send({result:x,message:J});0===s.length?t.status(200).send({result:q,data:""}):t.status(200).send({result:q,data:s[0].tradingviewChartId})})}),Me.post("/save-personal-chart",(e,t,s)=>{const r=e.body,{userId:o,chartId:n}=r,i=[[o,n]];let a=Object(B.sprintf)("INSERT INTO `%s`(`userId`, `tradingviewChartId`) VALUES ? ON DUPLICATE KEY UPDATE `userId` = VALUES(`userId`), `tradingviewChartId` = VALUES(`tradingviewChartId`);",h.settings);_.query(a,[i],(e,s,r)=>{if(e)return console.error(__filename,JSON.stringify(e)),void t.status(200).send({result:x,message:J});t.status(200).send({result:q,message:H})})});var Pe=Me;const We=i.a.Router();We.get("/email",function(e,t,s){const r=e.query,{token:o,email:n,name:i}=r,a="verify/email/fail";let l=Object(B.sprintf)("SELECT T.*, U.firstName FROM `tokens` T JOIN `%s` U ON U.email = T.email WHERE BINARY T.token = '%s';",h.users,o);_.query(l,null,(e,s,r)=>{if(e)return console.error(l,JSON.stringify(e)),void t.render(a,{baseUrl:O.baseUrl,result:x,message:J,error:e,email:n,name:i});if(0===s.length)t.render(a,{baseUrl:O.baseUrl,result:x,message:M,email:n,name:i}),console.log("invalid");else{const e=(new Date).getTime(),r=parseInt(s[0].expire);console.log("verify",e,r),e<r?(l=Object(B.sprintf)("UPDATE `%s` SET `allow` = 1 WHERE BINARY `email` = '%s';",h.users,s[0].email),_.query(l,null,e=>{e?(console.error(JSON.stringify(e)),t.render(a,{baseUrl:O.baseUrl,result:x,message:J,error:e,email:n,name:i})):(t.render("verify/email/success",{baseUrl:O.baseUrl,result:q,message:W,email:n,name:i}),console.log("success"))})):(t.render(a,{baseUrl:O.baseUrl,result:x,message:P,email:n,name:i}),console.log("expired"))}})});var Ve=We,He=s(10);const Ye=i.a.Router(),Fe=(e,t,s,r,o,n)=>{let i={symbol:t,side:"buy"===s?"Buy":"Sell",orderQty:r,ordType:"Market"};e.order(Ce,i,e=>{"function"==typeof o&&o({result:q,message:e})},e=>{console.error("error",e),"function"==typeof o&&o({result:x,message:JSON.parse(e)})})};Ye.post("/order/:cipher",(e,t,s)=>{const r=e.params;let{cipher:o}=r;o=o.replace(/@/g,"/");let n=He.AES.decrypt(o,A).toString(He.enc.Utf8),[i,a,l]=n.split("/");l=l.toLowerCase(),console.log("signal-bot",i,a,l);let u=Object(B.sprintf)("SELECT U.* FROM `%s` U WHERE BINARY U.id = '%s' AND BINARY U.hash = '%s';",h.users,i,a);_.query(u,null,(e,s,r)=>{if(e)return console.error("signalBot",JSON.stringify(e)),void t.status(200).send({result:x,message:J});if(0===s.length)return void t.status(200).send({result:x,message:Q});let o=s[0];u=Object(B.sprintf)("SELECT * FROM `%s` WHERE `userId` = '%s';",h.apikeys,o.id),_.query(u,null,(e,s,r)=>{if(e)return console.error("signalBot",JSON.stringify(e)),void t.status(200).send({result:x,message:J});if(0===s.length)return void t.status(200).send({result:x,message:ie});const{testnet:n,apiKey:i,apiKeySecret:a}=s[0],c=new je(n,i,a);u=Object(B.sprintf)("SELECT B.* FROM `%s` S JOIN `%s` B WHERE S.userId = '%s' AND B.botLogic = 'signal';",h.settings,h.bots,o.id),_.query(u,null,(e,s,r)=>{if(e)return console.error("signalBot",JSON.stringify(e)),void t.status(200).send({result:x,message:J});if(0===s.length)return void t.status(200).send({result:x,message:ae});const{leverage:o,closeOnTrigger:n,orderType:i,side:a,quantity:u}=s[0];let d={symbol:"XBTUSD",leverage:o};c.positionLeverage(d,e=>{c.position({symbol:"XBTUSD"},e=>{if(e.length>0){const s=e[0];if(0===s.currentQty)return void Fe(c,"XBTUSD","buy"===l?"buy":"sell",u,e=>t.status(200).send(e),e=>t.status(200).send(e));if(s.currentQty>0&&"buy"===l||s.currentQty<0&&"sell"===l)return void t.send({result:x,message:s.currentQty>0?le:ue});d={symbol:"XBTUSD",side:s.currentQty>0?"Sell":"Buy",orderQty:u,ordType:"Market",execInst:"Close"},c.order(Ce,d,e=>{Fe(c,"XBTUSD","buy"===l?"buy":"sell",u,e=>t.status(200).send(e),e=>t.status(200).send(e))},e=>{console.error("error",e),t.send({result:x,message:JSON.parse(e)})})}else Fe(c,"XBTUSD","buy"===l?"buy":"sell",u,e=>t.status(200).send(e),e=>t.status(200).send(e))},e=>{console.error("error",e),t.send({result:x,message:JSON.parse(e)})})},e=>{console.error("error",e,d),t.send({result:x,message:JSON.parse(e)})})})})})});var Xe=Ye;const ze=i.a.Router();ze.use("/",k),ze.use("/auth",Te),ze.use("/dashboard",de),ze.use("/register-bots",Le),ze.use("/register-apikeys",Ie),ze.use("/settings",Pe),ze.use("/verify",Ve),ze.use("/signal-bot",Xe);var Qe=ze;const Ge=i()();Ge.set("views",l.a.join(__dirname,"views")),Ge.set("view engine","pug"),Ge.use(p()("dev")),Ge.use(i.a.json()),Ge.use(i.a.urlencoded({extended:!1})),Ge.use(c()()),Ge.use(y()()),Ge.use(b()()),Ge.use("/api",g()({secret:E.secret}).unless({path:["/api/auth/sign-in","/api/auth/sign-up",/\/api\/market-sentiment\/one\/*/,/\/api\/market-sentiment\/collection\/*/,/\/api\/deribit\/data\/*/,/\/api\/verify\/*/,/\/api\/signal-bot\/order\/*/]})),Ge.use("/api",Qe),Ge.use(i.a.static(l.a.join(__dirname,"frontend"))),Ge.get("*",function(e,t){t.sendFile(l.a.join(__dirname,"frontend/index.html"))}),Ge.use(function(e,t,s){s(o()(404))}),Ge.use(function(e,t,s,r){s.locals.message=e.message,s.locals.error="development"===t.app.get("env")?e:{},s.status(e.status||500),s.render("error")});var $e=Ge,Ze=s(20),et=s.n(Ze),tt=s(4),st=s.n(tt),rt=s(21),ot=s.n(rt),nt=s(11),it=s.n(nt),at="price",lt="orderBookL2_25",ut="wallet",ct="position",dt="connectToExchange",pt="connectedToExchange",mt="disconnectFromExchange",gt="disconnectedFromExchange",ft="checkIsConnected",yt="answerIsConnected",St="startBot",bt="stopBot",Ot="checkIsBotStarted",Et="answerIsBotStarted";let ht={timeoutDelay:3e4,webSocketTimeoutId:void 0,ioServer:void 0,prices:{},orderBooksL2_25:[],webSocket:void 0,webSocketLastTimestamp:void 0,subscribes:[],exchangeClients:new Map,apiKey2Socket:new Map,apiKey2User:new Map,wallets:new Map,positions:new Map,bots:new Map,renewSocket:()=>{const e=(new Date).getTime();if(ht.webSocketTimeoutId&&clearTimeout(ht.webSocketTimeoutId),ht.webSocketTimeoutId=setTimeout(ht.renewSocket,ht.timeoutDelay),ht.webSocketLastTimestamp>e-ht.timeoutDelay)return;const t=Boolean(v.testnet)?v.wsUrlTestnet:v.wsUrlRealnet;ht.webSocket=new it.a(t,{retryCount:2,reconnectInterval:1}),console.error(__filename,"renewSocket",ht.webSocketLastTimestamp),ht.webSocket.on("connect",()=>{for(let e of ht.subscribes)ht.webSocket.send(e)}),ht.webSocket.on("message",e=>{if(ht.webSocketLastTimestamp=(new Date).getTime(),(e=JSON.parse(e)).request&&console.log(__filename,"message",JSON.stringify(e)),e.table){const t=e.table;"instrument"===t?ht.onWsInstrument(e.action,e.data):"orderBookL2_25"===t&&ht.onWsOrderBookL2_25(e.action,e.data)}}),ht.webSocket.on("reconnect",e=>{const t=(new Date).toISOString();console.error(__filename,"reconnect",t)}),ht.webSocket.on("destroyed",t=>{console.error(__filename,"destroyed",e)}),ht.webSocket.start()},signMessage:(e,t,s,r,o)=>(!o||qe.a.isEmpty(o)?o="":qe.a.isObject(o)&&(o=JSON.stringify(o)),fe.a.createHmac("sha256",e).update(t+s+r+o).digest("hex")),initSocketIOServer:e=>{ht.ioServer=e,e.on("connection",e=>{e.on(dt,t=>{const s=JSON.parse(t),{testnet:r,apiKey:o,apiKeySecret:n,username:i,firstName:a,lastName:l}=s;let u;if(ht.exchangeClients.has(o)){if((u=ht.exchangeClients.get(o)).isConnected)return}else{const e=Boolean(r)?v.wsUrlTestnet:v.wsUrlRealnet;u=new it.a(e,{retryCount:2,reconnectInterval:1})}u.on("connect",()=>{new je(r,o,n).getTimestamp(t=>{const r=parseInt(t/1e3+5),i=ht.signMessage(n,"GET","/realtime",r);u.send(JSON.stringify({op:"authKeyExpires",args:[o,r,i]})),u.send(JSON.stringify({op:"subscribe",args:["orderBookL2_25:XBTUSD","order:XBTUSD","wallet","position:XBTUSD"]})),e.emit(pt,JSON.stringify(s))})}),u.on("message",e=>{const t=JSON.parse(e);if(t.request&&console.log(__filename,"message",e),t.table){const e=t.table;"order"===e?ht.onWsOrder(o,t.action,t.data):"wallet"===e?ht.onWsWallet(o,t.action,t.data):"position"===e&&ht.onWsPosition(o,t.action,t.data)}}),u.on("reconnect",e=>{const t=(new Date).toISOString();console.error(__filename,"reconnect-client",o,t)}),u.on("destroyed",t=>{console.error(__filename,"destroyed-client",o),e.emit(gt)}),u.start(),ht.exchangeClients.set(o,u),ht.apiKey2Socket.set(o,e),ht.apiKey2User.set(o,{username:i,firstName:a,lastName:l})}),e.on(mt,e=>{const t=JSON.parse(e),{testnet:s,apiKey:r,apiKeySecret:o}=t;ht.exchangeClients.get(r).send(JSON.stringify({op:"unsubscribe",args:["orderBookL2_25:XBTUSD","order:XBTUSD","wallet","position:XBTUSD"]})),ht.exchangeClients.get(r).destroy(),ht.exchangeClients.delete(r),ht.apiKey2User.delete(r)}),e.on(ft,t=>{const s=JSON.parse(t),{testnet:r,apiKey:o,apiKeySecret:n}=s;let i;if(ht.exchangeClients.has(o)){const t=ht.exchangeClients.get(o),r=ht.apiKey2User.get(o);i=JSON.stringify({connected:t.isConnected,apiKey:s,user:r}),t.isConnected&&ht.apiKey2Socket.set(o,e)}else i=JSON.stringify({connected:!1,apiKey:s,user:{}});e.emit(yt,i);let a=ht.wallets.get(o);a&&e.emit(ut,JSON.stringify(a)),(a=ht.positions.get(o))&&e.emit(ct,JSON.stringify(a))}),e.on(St,t=>{const s=JSON.parse(t),{testnet:r,apiKey:o,apiKeySecret:n,userId:i}=s;let a=Object(B.sprintf)("SELECT B.* FROM `%s` B JOIN `%s` S ON S.activeBotId = B.id WHERE S.userId = '%d';",h.bots,h.settings,i);_.query(a,null,(t,s,a)=>{if(t)return console.error(__filename,JSON.stringify(t)),void e.emit(Et,JSON.stringify({started:!1,message:J}));if(0===s.length)return void e.emit(Et,JSON.stringify({started:!1,message:te}));const l=new je(r,o,n),u=s[0];let c;c={symbol:u.symbol,leverage:u.leverageValue},l.positionLeverage(c,e=>{const t="Long"===u.strategy,s="Limit"===u.orderType;c={symbol:u.symbol,side:t?"Buy":"Sell",orderQty:u.quantity,price:s?u.price:void 0,ordType:s?"Limit":"Market",text:ne},l.order(Ce,c,e=>{console.log("Bot-order",JSON.stringify(c))},e=>{console.error("Bot-order",JSON.stringify(e),JSON.stringify(c))});let r=Math.round(u.price*(1+(t?1:-1)*u.tpPercent/100));c={symbol:u.symbol,side:t?"Sell":"Buy",orderQty:Math.floor(u.quantity*u.tpPercent/100),ordType:"MarketIfTouched",execInst:"Close,LastPrice",stopPx:r,text:ne},l.order(Ce,c,e=>{console.log("take-profit",JSON.stringify(c))},e=>{console.error("take-profit",JSON.stringify(e),JSON.stringify(c))}),r=Math.round(u.price*(1-(t?1:-1)*u.slPercent/100)),c={symbol:u.symbol,side:t?"Sell":"Buy",orderQty:Math.floor(u.quantity*u.tpPercent/100),ordType:"Stop",execInst:"Close,LastPrice",stopPx:r,text:ne},l.order(Ce,c,e=>{console.log("stop-profit",JSON.stringify(c))},e=>{console.error("stop-profit",JSON.stringify(e),JSON.stringify(c))})},e=>{console.error("Bot-order-leverage",JSON.stringify(e),JSON.stringify(c))}),ht.bots.set(i,{rest:l,config:u}),e.emit(Et,JSON.stringify({started:!0,message:se}))})}),e.on(bt,t=>{const s=JSON.parse(t),{testnet:r,apiKey:o,apiKeySecret:n,userId:i}=s;e.emit(Et,JSON.stringify({started:!1,message:re}));const a=ht.bots.get(i);console.error("bot",a);let l={symbol:a.config.symbol};a.rest.orderAll(l,e=>{ht.bots.delete(i)},e=>{ht.bots.delete(i)})}),e.on(Ot,t=>{const s=JSON.parse(t),{testnet:r,apiKey:o,apiKeySecret:n,userId:i}=s;e.emit(Et,JSON.stringify({started:ht.bots.has(i),message:oe}))})})},onWsInstrument:(e,t)=>{let s;for(let e of t)s=1,e.symbol&&e.lastPrice&&(ht.prices[e.symbol]&&(s=Math.sign(e.lastPrice-ht.prices[e.symbol].price)),ht.prices[e.symbol]={price:e.lastPrice,direction:s}),ht.ioServer.sockets.emit(at,JSON.stringify(ht.prices))},onWsOrderBookL2_25:(e,t)=>{if("partial"===e){ht.orderBooksL2_25={Buy:[],Sell:[]};for(let e of t)ht.orderBooksL2_25[e.side].push(e)}else if("update"===e){let e,s,r;for(let o of t)e=!1,s=qe.a.findIndex(ht.orderBooksL2_25.Buy,{id:o.id}),r=qe.a.findIndex(ht.orderBooksL2_25.Sell,{id:o.id}),-1!=s?(ht.orderBooksL2_25.Buy[s].price=o.price?o.price:ht.orderBooksL2_25.Buy[s].price,ht.orderBooksL2_25.Buy[s].size=o.size?o.size:ht.orderBooksL2_25.Buy[s].size):-1!=r&&(ht.orderBooksL2_25.Sell[r].price=o.price?o.price:ht.orderBooksL2_25.Sell[r].price,ht.orderBooksL2_25.Sell[r].size=o.size?o.size:ht.orderBooksL2_25.Sell[r].size)}else if("insert"===e)for(let e of t)ht.orderBooksL2_25[e.side].push(e);else if("delete"===e)for(let e of t)qe.a.remove(ht.orderBooksL2_25.Buy,{id:e.id}),qe.a.remove(ht.orderBooksL2_25.Sell,{id:e.id});let s={Buy:ht.orderBooksL2_25.Buy,Sell:ht.orderBooksL2_25.Sell};ht.ioServer.sockets.emit(lt,JSON.stringify(s))},onWsOrder:(e,t,s)=>{console.error(t,JSON.stringify(s))},onWsWallet:(e,t,s)=>{if("partial"===t)ht.wallets.set(e,s);else if("insert"===t){let t=ht.wallets.get(e);t=qe.a.concat(t,s),ht.wallets.set(e,t)}else if("update"===t){let t,r=ht.wallets.get(e);for(let e of s)t=qe.a.findIndex(r,{account:e.account}),Object.keys(e).map((s,o)=>{r[t][s]=e[s]});ht.wallets.set(e,r)}else if("delete"===t){let t=ht.wallets.get(e);for(let e of s)t=qe.a.remove(wallet,{account:e.account});ht.wallets.set(e,t)}const r=ht.apiKey2Socket.get(e);if(r){const t=ht.wallets.get(e);r.emit(ut,JSON.stringify(t))}},onWsPosition:(e,t,s)=>{if("partial"===t)ht.positions.set(e,s);else if("insert"===t){let t=ht.positions.get(e);t=qe.a.concat(t,s),ht.positions.set(e,t)}else if("update"===t){let t,r=ht.positions.get(e);for(let e of s)t=qe.a.findIndex(r,{account:e.account,symbol:e.symbol}),Object.keys(e).map((s,o)=>{r[t][s]=e[s]});ht.positions.set(e,r)}else if("delete"===t){let t=ht.positions.get(e);for(let e of s)t=qe.a.remove(t,{account:e.account,symbol:e.symbol});ht.positions.set(e,t)}const r=ht.apiKey2Socket.get(e);if(r){const t=ht.positions.get(e);r.emit(ct,JSON.stringify(t))}},start:e=>{if(ht.subscribes=[],e instanceof Array){let t;for(let s of e)t=JSON.stringify({op:"subscribe",args:s}),ht.subscribes.push(t)}ht.renewSocket()}};var vt=ht;let Tt,Nt,wt,It;st.a.isMaster&&(st.a.fork(),st.a.on("exit",function(e,t,s){st.a.fork()})),st.a.isWorker&&(Tt=new Je.a("express:server"),Nt=function(e){const t=parseInt(e,10);if(isNaN(t))return e;if(t>=0)return t;return!1}(O.port),$e.set("port",Nt),wt=et.a.createServer($e),It=ot()(wt),vt.initSocketIOServer(It),vt.start(["instrument:XBTUSD","orderBookL2_25:XBTUSD"]),wt.listen(Nt),wt.on("error",function(e){if("listen"!==e.syscall)throw e;const t="string"==typeof Nt?"Pipe "+Nt:"Port "+Nt;switch(e.code){case"EACCES":console.error(t+" requires elevated privileges"),process.exit(1);break;case"EADDRINUSE":console.error(t+" is already in use"),process.exit(1);break;default:throw e}}),wt.on("listening",function(){const e=wt.address(),t="string"==typeof e?"pipe "+e:"port "+e.port;Tt("Listening on "+t),console.log("Listening on "+t)}))}]);